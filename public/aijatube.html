<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Watcher test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}

/* HEADER */
header {
  padding: 15px;
  background: #090009;
  display: flex;
  gap: 10px;
}

input {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
}

button {
  padding: 12px 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: linear-gradient(135deg,#7f00ff,#b56cff);
  color: white;
  font-weight: bold;
}

/* PLAYER */
#player iframe {
  width: 100%;
  height: 60vh;
  border: none;
}

/* RESULTS */
#results {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  gap: 15px;
  padding: 15px;
}

.video {
  background: #0d0016;
  border-radius: 10px;
  cursor: pointer;
  overflow: hidden;
  transition: transform .15s;
}

.video:hover {
  transform: scale(1.03);
}

.video img {
  width: 100%;
  display: block;
}

.video p {
  padding: 8px;
  font-size: 14px;
}
</style>
</head>

<body>

<header>
  <input id="search" placeholder="Search videos..." />
  <button onclick="searchVideos()">Search</button>
</header>

<div id="player"></div>
<div id="results"></div>

<script>
/* ================= INVIDIOUS INSTANCES ================= */
const INSTANCES = [
  "https://vid.puffyan.us",
  "https://invidious.fdn.fr",
  "https://yewtu.be",
  "https://invidious.snopyta.org"
];

let instance = null;

/* ================= INSTANCE PICKER ================= */
async function getInstance() {
  if (instance) return instance;

  for (const url of INSTANCES) {
    try {
      const testURL = `https://api.allorigins.win/raw?url=` +
        encodeURIComponent(`${url}/api/v1/search?q=test&type=video`);
      const r = await fetch(testURL);
      if (r.ok) {
        instance = url;
        console.log("Using Invidious:", url);
        return url;
      }
    } catch {}
  }

  alert("No video services available.");
  throw new Error("No instance");
}

/* ================= SEARCH ================= */
async function searchVideos() {
  const q = document.getElementById("search").value.trim();
  if (!q) return;

  const results = document.getElementById("results");
  results.innerHTML = "<p>Searching...</p>";

  try {
    const inst = await getInstance();
    const apiURL = `${inst}/api/v1/search?q=${encodeURIComponent(q)}&type=video`;

    const res = await fetch(
      "https://api.allorigins.win/raw?url=" + encodeURIComponent(apiURL)
    );

    const data = await res.json();
    results.innerHTML = "";

    data.slice(0, 24).forEach(v => {
      const div = document.createElement("div");
      div.className = "video";
      div.innerHTML = `
        <img src="${v.videoThumbnails?.[3]?.url || ""}">
        <p>${v.title}</p>
      `;
      div.onclick = () => playVideo(v.videoId);
      results.appendChild(div);
    });

  } catch (e) {
    console.error(e);
    results.innerHTML = "<p>Search failed.</p>";
  }
}

/* ================= PLAYER ================= */
function playVideo(id) {
  document.getElementById("player").innerHTML = `
    <iframe
      src="${instance}/embed/${id}"
      allowfullscreen
      referrerpolicy="no-referrer"
    ></iframe>
  `;
}

/* ================= ENTER KEY ================= */
document.getElementById("search").addEventListener("keydown", e => {
  if (e.key === "Enter") searchVideos();
});
</script>

</body>
</html>
